# MA 加权量化交易脚本

使用脚本前，请先获取Apikey对，并开启期货交易权限，一定要保管好，这等同于你的账号密码！ 

申请方式参阅 https://www.binance.com/zh-CN/support/faq/detail/360002502072 

本策略是MA策略的升级版实现，如您有策略的定制化需求，这边也能协助开发哦

## 一、脚本的核心逻辑

这个程序的作用，就是**帮你用不同时间周期的均线（MA）来判断现在应该买多少、卖多少**。

它的基本思路是这样的：

### 加权持仓比例的计算举例

假设你关注 4 个周期：

- **15分钟**（权重 0.3）
- **1小时**（权重 0.2）
- **4小时**（权重 0.2）
- **1天**（权重 0.3）

程序会判断三个关系是否满足：
  - **MA7 > MA14** 
  - **MA14 > MA28** 
  - **MA7 > MA28**

根据指标可以分析得到

- 如果 **MA7 > MA14**，说明趋势向上 → 看涨
- 如果 **MA7 < MA14**，说明趋势向下 → 看空
- 其余MA以此类推

最终，每个周期会根据 MA7、MA14、MA28 的关系给出一个信号分数,举例如下：

------

### 场景示例

某一时刻，系统得到的信号是：

| 周期   | 权重 | 信号（0~1） | 解释                 |
| ------ | ---- | ----------- | -------------------- |
| 15分钟 | 0.3  | 1.0         | MA 排列完全看多      |
| 1小时  | 0.2  | 0.66        | 三个条件里满足了两个 |
| 4小时  | 0.2  | 0.33        | 三个条件里满足了一个 |
| 1天    | 0.30 | 1.0         | 完全看多             |

------

### 加权求和的过程

1. 15分钟的信号很强（1.0），再乘上它的“重要性”0.3 → 得分 0.3
2. 1小时信号中等（0.66），重要性 0.2 → 得分大约 0.13
3. 4小时信号偏弱（0.33），重要性 0.2 → 得分大约 0.07
4. 1天信号很强（1.0），重要性 0.3 → 得分 0.3

最后把它们加起来：
 **0.3 + 0.13 + 0.07 + 0.3 = 0.8**

------

### 结果的意义

- 得到的结果是 **0.8**（即 80%）
- 这意味着在`long`模式下，当前建议用 **最大仓位的 80% 做多**
- 如果是 `both` 模式，这个结果会再换算到 **-1 ~ +1** 之间，方便表示“做多/做空”强度
  - 比如 0.8 会变成 **+0.6**（表示强烈做多）
  - 如果结果是 0.3，会变成 **-0.4**（表示适度做空）
- 如果是 `short` 模式，则只做空**最大仓位的20%**


### 根据公式计算开仓大小

最后用公式算出具体开多少仓位

   ```
   开仓名义价值 = 持仓比例 × 总资金 × 杠杆
   ```

------

## 二、如何使用

### 1. 准备配置文件

程序有两个关键配置文件：

#### （1）`config.json`

这里决定了交易策略怎么跑，示例如下：


```json
// json文件其实是不能使用注释的，请直接修改`config.json`，不要直接复制这里的哦。
{
    // APIkey也可以使用.env文件配置，优先使用.env的
  "API_KEY": "",
  "API_SECRET": "",
    // 要交易的交易对
  "symbols": ["ETHUSDC", "SOLUSDC", "DOGEUSDC"],
    // 采用的k线大小
  "intervals": ["15m", "1h", "4h", "1d"],
    // 每种交易对的最大杠杆
  "allocations": {
    "ETHUSDC": 1,
    "SOLUSDC": 1,
    "DOGEUSDC": 1
  },
    // 各周期k线的采信权重
  "weights": {
    "15m": 0.3,
    "1h": 0.2,
    "4h": 0.2,
    "1d": 0.3
  },
    // both|long|short 双向开仓/只开多/只开空（重要，后面会详细解释）
  "mode": "both",
    // 直接市价成交还是跟踪委托成交
  "per_symbol_order_type": {
    "ETHUSDC": "market",
    "SOLUSDC": "tracking",
    "DOGEUSDC": "tracking"
  },
    // 不具体执行下单操作，只输出日志，用于测试
  "dry_run": false,
    // 使用的apikey是否为测试网的
  "testnet": false,
    // 获取更详细的日志输出
  "debug": true
}

```

####  字段逐条解释

##### 1）账号密钥

- `API_KEY` / `API_SECRET`：你的币安 API 密钥。
  - 更推荐放在 `.env` 文件中（安全）；如果 json 这里也填了，`.env` 优先）。

##### 2）交易对象

- `symbols`：要交易的**U本位合约**交易对（示例用了 USDC 计价：`ETHUSDC`、`SOLUSDC`、`DOGEUSDC`）。
- `intervals`：用哪些周期的K线来判断趋势。这里是 `15m`、`1h`、`4h`、`1d`。

##### 3）资金分配

- `allocations`：给每个交易对分配多少“名义资金权重”。
  - 例：`"ETHUSDC": 1` 表示用**账户权益 × 1** 作为 ETHUSDC 的目标名义（再乘以持仓比例）。
  - 可以**大于 1** 当做“加杠杆目标”（最终是否能下那么多，由交易所最小名义限制&你的保证金决定）。
  - 有多个交易对的情况是相加关系，如 **"ETHUSDC": 1  , "SOLUSDC": 1** 的情况，会各开账户权益 × 1 的单，最大情况下相当于两倍杠杆

##### 4）周期权重

- `weights`：每个周期在“趋势评分”里的重要程度。
  - 例：`15m: 0.3` 表示 15 分钟周期的信号占 30% 权重。
  - 一般**长周期更稳**，可给 `1h/4h/1d` 更高的权重。

##### 5）持仓模式（很重要）

- `mode: "both" | "long" | "short"`
  - `both`（双向）：建议持仓比例会被映射到 **[-1, 1]**，
     -1=全仓做空，0=空仓，+1=全仓做多。（默认、最灵活）
  - `long`（只做多）：建议持仓比例会被映射到 **[0, 1]**。
  - `short`（只做空）：建议持仓比例会被映射到 **[-1, 0]**。

> 映射逻辑（以 `both` 为例）：
>  程序先算出一个 `target_ratio ∈ [0,1]`（越接近 1 越偏多），然后
>  `net_frac = 2 * (target_ratio - 0.5)` → 得到 [-1, 1] 的净仓位比例。

##### 6）下单方式

- `per_symbol_order_type`：为每个交易对选择 `"market"` 或 `"tracking"`。
  - `"market"`（市价）：**直接吃单**，即刻成交，滑点可能稍大，但不拖泥带水。
  - `"tracking"`（跟踪委托，**推荐**）：
    - 程序会**始终把挂单放在最优价**：
      - 买入时挂在**买一价**（best bid），
      - 卖出时挂在**卖一价**（best ask）。
    - 如果盘口变动导致你的单**不再是最优价**，程序会**撤单**并**以最新最优价重挂**。
    - 好处：**尽量少滑点** ，**节约手续费**
       风险：**可能迟迟挂不成**（价格跑掉/对手单不足）

##### 7）测试开关

- `dry_run`：**仿真模式**。`true`=只打印不下单（强烈建议先开）。
- `testnet`：**测试网**。`true`=连接测试网（配合测试网 API Key 使用）。
- `debug`：打印更详细日志（含 MA 表格、计算细节、订单跟踪过程）。

#### （2）`.env`（可选）

在同目录下创建一个`.env`文件（文件名就是`.env`），单独存放你的 **API Key** 和 **Secret**，更加安全。程序会优先使用`.env`的信息。

```
API_KEY=你的apikey
API_SECRET=你的apisecret
```

**注意**：不要把 `.env` 上传到任何地方！防止别人盗用你的账户。


### 2. 安装必要运行库
```
// requirement.txt
python-binance
websocket-client
python-dotenv
tabulate
```
### 3. 启动程序

运行脚本：

```bash
python main.py
```

------

**谨记：本脚本只用于学习交流，请自负盈亏。**